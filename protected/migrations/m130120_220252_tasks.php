<?php

class m130120_220252_tasks extends CDbMigration
{
	public function up()
	{
        $connection = $this->getDbConnection();
        $transaction = $connection->beginTransaction();
        try
        {
            $tasks = $connection->createCommand("SELECT `t`.id, `t`.start_time FROM `tasks` AS `t`")->queryAll();
            $this->alterColumn('tasks', 'start_time', 'time DEFAULT NULL');
            foreach($tasks as $task) {
                if(empty($task['start_time']) || $task['start_time'] == "0" || $task['start_time'] == 0){
                    $start_time = null;
                }else{
                    $start_time = gmdate('H:i:s', (int)$task['start_time']*60);
                }

                $this->update('tasks', ['start_time'=>$start_time], "id = ".$task['id']);
            }
        }
        catch(Exception $e)
        {
            echo "Exception: ".$e->getMessage()."\n";
            $transaction->rollback();
            return false;
        }
	}

	public function down()
	{
        $connection = $this->getDbConnection();
        $transaction = $connection->beginTransaction();
        try
        {

            $tasks = "
                SET NAMES utf8;
                SET FOREIGN_KEY_CHECKS = 0;

                -- ----------------------------
                --  Table structure for `tasks`
                -- ----------------------------
                DROP TABLE IF EXISTS `tasks`;
                CREATE TABLE `tasks` (
                  `id` int(11) NOT NULL AUTO_INCREMENT,
                  `title` varchar(200) NOT NULL,
                  `start_time` int(11) NOT NULL,
                  `duration` int(11) NOT NULL,
                  `type` int(11) NOT NULL,
                  `sim_id` int(11) DEFAULT NULL,
                  `code` varchar(5) DEFAULT NULL,
                  `start_type` varchar(5) DEFAULT NULL,
                  `category` tinyint(1) DEFAULT NULL,
                  PRIMARY KEY (`id`),
                  KEY `fk_tasks_sim_id` (`sim_id`)
                ) ENGINE=InnoDB AUTO_INCREMENT=219 DEFAULT CHARSET=utf8;

                -- ----------------------------
                --  Records of `tasks`
                -- ----------------------------
                BEGIN;
                INSERT INTO `tasks` VALUES ('1', 'Поставить задачи сотрудникам на время моего отпуска', '0', '90', '1', null, 'P01', 'start', '2'), ('2', 'Проверить работу Аналитика 2 по ценовой политике', '0', '30', '1', null, 'P02', 'start', '3'), ('3', 'Согласовать с производственным отделом новую отчетную форму', '0', '30', '1', null, 'P03', 'start', '3'), ('4', 'Запустить сбор информации по продажам 3 квартала', '0', '30', '1', null, 'P04', 'start', '3'), ('5', 'Позвонить в АХО про работу батарей - плохо работают', '0', '30', '1', null, 'P05', 'start', '4'), ('6', 'Подготовить итоговый отчет \"Прибыли и убытки\" для Генерального директора по 1 полугодию (жду протокол Правления)', '0', '90', '1', null, 'P06', 'start', '2'), ('7', 'Ответить на запрос HR по новой системе мотивации', '0', '90', '1', null, 'P07', 'start', '4'), ('8', 'Доклад ГД на конференции в декабре ', '0', '180', '1', null, 'P08', 'start', '3'), ('9', 'Рассказать моим сотрудникам о новой системе премирования с 4 кв. ', '0', '30', '1', null, 'P09', 'start', '2'), ('10', 'Посмотреть договор от юристов (уже третий раз присылают)', '0', '60', '1', null, 'P010', 'start', '4'), ('11', 'Проверить, что сделал аналитик 1 по задаче логистического отдела.  Трудякин просил сегодня.', '0', '30', '1', null, 'P011', 'start', '1'), ('12', 'Встретиться с аналитиком 3 по результатам испытательного срока', '0', '60', '1', null, 'P012', 'start', '3'), ('13', 'Срочно доделать сводный бюджет', '0', '180', '1', null, 'P013', 'start', '1'), ('14', 'Проверить презентацию для ГД в четверг. Крутько обещала в 15.30', '0', '30', '1', null, 'P3', 'start', '1'), ('15', 'Встреча с клиентом по автоматизации данных, предварительно четверг, час или два дня', '0', '60', '1', null, 'P015', 'start', '3'), ('16', 'Совещание \" О старте годовой аттестации\", 17.00', '0', '90', '1', null, 'P016', 'start', '4'), ('17', 'Встреча с ГД в 16.00 по презентации', '960', '30', '2', null, 'P017', 'start', '1'), ('18', 'Обед', '0', '30', '1', null, 'P018', 'start', '2'), ('19', 'Уйти с работы на день рождения тещи (заехать за цветами)', '0', '60', '1', null, 'P019', 'start', '2'), ('20', 'Встреча с Иваном Доброхотовым в 18.00', '0', '60', '1', null, 'P5', 'new', '2'), ('21', 'Позвонить Ивану Доброхотову после отпуска, договориться о встрече', '0', '30', '1', null, 'P6', 'new', '3'), ('22', 'Встреча с консультантом по стратегии', '0', '120', '1', null, 'P4', 'new', '4'), ('23', 'Повторная встреча с клиентом о возможности автоматического предоставления данных', '0', '60', '1', null, 'P1', 'new', '2'), ('24', 'Написать протокол по встрече с клиентом', '0', '30', '1', null, 'P2', 'new', '3'), ('25', 'Написать служебку о выделении денег на замену сервера', '0', '30', '1', null, 'P17', 'new', '4'), ('26', 'Внести изменения в сводный бюджет - новые данные по Производству', '0', '30', '1', null, 'P18', 'new', '2'), ('27', 'Отправить Денежной исправленный отчет для Правления через час', '0', '30', '1', null, 'P8', 'new', '3'), ('28', 'Отправить Денежной исправленный отчет для Правления к 10.30 завтра', '0', '30', '1', null, 'P9', 'new', '4'), ('29', 'Встреча с Мариной Крутько по новым задачам', '0', '90', '1', null, 'P10', 'new', '4'), ('30', 'Забрать машину в обед', '0', '30', '1', null, 'P12', 'new', '3'), ('31', 'Встреча с логистом по проекту интеграции данных с клиентами', '0', '30', '1', null, 'P13', 'new', '2'), ('32', 'Позвонить Васильеву из региона А по бюджету и его жалобе', '0', '30', '1', null, 'P14', 'new', '2'), ('33', 'Позвонить директору по продажам по процессу формирования бюджета в продажах', '0', '30', '1', null, 'P15', 'new', '4'), ('34', 'Встреча с Директором по продажам по процессу бюджетирования', '0', '30', '1', null, 'P16', 'new', '2'), ('35', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', null, 'P28', 'new', '3'), ('36', 'Написать тезисы выступления на конференции \"Аналитика и бизнес\"', '0', '90', '1', null, 'P29', 'new', '3'), ('37', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', null, 'P20', 'new', '3'), ('38', 'Подготовить график отпусков', '0', '60', '1', null, 'P21', 'new', '4'), ('39', 'Провести индивидуальные встречи с аналитиками', '0', '90', '1', null, 'P22', 'new', '2'), ('42', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '1684', null, null, null), ('43', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '1684', null, null, null), ('44', 'Подготовить данные по экономике компании для встречи с консультантами', '0', '180', '1', '1772', null, null, null), ('45', 'Подготовить данные по экономике компании для встречи с консультантами', '0', '180', '1', '1773', null, null, '5'), ('46', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '1838', null, null, '5'), ('47', 'Подготовить документ о конфиденциальности и не разглашении  информации', '0', '60', '1', '1838', null, null, '5'), ('48', 'Купить книгу по продвинутому использованию программы Excel', '0', '30', '1', '1865', null, null, '5'), ('49', 'Внести изменения в сводный бюджет на базе последних данных от производства', '0', '30', '1', '1865', null, null, '5'), ('50', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '1868', null, null, '5'), ('51', 'Запланировать деньги на сервер в бюджете на январь', '0', '30', '1', '1909', null, null, '5'), ('52', 'Подготовить данные по экономике компании для встречи с консультантами', '0', '180', '1', '1909', null, null, '5'), ('53', 'Подготовить регламент адаптации и введения в должность сотрудников отдела анализа и региональных сотрудников', '0', '180', '1', '1909', null, null, '5'), ('54', 'Подготовиться к встрече с консультантами', '0', '30', '1', '1956', null, null, '5'), ('55', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2065', null, null, '5'), ('56', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2237', null, null, '5'), ('57', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2246', null, null, '5'), ('58', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '2246', null, null, '5'), ('59', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2247', null, null, '5'), ('60', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2247', null, null, '5'), ('61', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2248', null, null, '5'), ('62', 'Запланировать деньги на сервер в бюджете на январь', '0', '30', '1', '2260', null, null, '5'), ('63', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '2260', null, null, '5'), ('64', 'Подготовить документ о конфиденциальности и не разглашении  информации', '0', '60', '1', '2262', null, null, '5'), ('65', 'Найти и переслать старый график отпусков', '0', '30', '1', '2264', null, null, '5'), ('66', 'Доделать презентацию для ГД', '0', '180', '1', '2264', null, null, '5'), ('67', 'Проверить в бюджете наличие средств на покупку фото файлов', '0', '30', '1', '2264', null, null, '5'), ('68', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2266', null, null, '5'), ('69', 'Подготовиться к встрече с консультантами', '0', '30', '1', '2267', null, null, '5'), ('70', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '2267', null, null, '5'), ('71', 'Написать служебку на выделение денег для сервера', '0', '30', '1', '2281', null, null, '5'), ('72', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '2282', null, null, '5'), ('101', 'Подготовить документ о конфиденциальности и не разглашении  информации', '0', '60', '1', '2297', null, null, '5'), ('106', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2324', null, null, '5'), ('107', 'Встретиться с Сергеем Ивановичем', '0', '60', '1', '2353', null, null, '5'), ('108', 'Подготовить регламент адаптации и введения в должность сотрудников отдела анализа', '0', '180', '1', '2407', null, null, '5'), ('109', 'Написать служебку на выделение денег для сервера', '0', '30', '1', '2408', null, null, '5'), ('110', 'Запланировать деньги на сервер в бюджете на январь', '0', '30', '1', '2473', null, null, '5'), ('111', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '2497', null, null, '3'), ('112', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '2552', null, null, '3'), ('113', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2562', null, null, '5'), ('114', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '2574', null, null, '5'), ('115', 'Встретиться с нач.логистики для обсуждения сроков отчетности', '0', '60', '1', '2578', null, null, '5'), ('116', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '2604', null, null, '5'), ('122', 'Заказать исследования по динамике рынка', '0', '60', '1', '2655', null, null, '5'), ('123', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2660', null, null, '5'), ('124', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2739', null, null, '5'), ('126', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2857', null, null, '5'), ('127', 'Подготовить документ о конфиденциальности и не разглашении  информации', '0', '60', '1', '2857', null, null, '5'), ('128', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '2872', null, null, '5'), ('129', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2872', null, null, '5'), ('130', 'Проверить наши прогнозы по продажам в сводном бюджете на базе данных о динамике рынка', '0', '90', '1', '2881', null, null, '5'), ('131', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '2934', null, null, '5'), ('133', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '3672', null, null, '3'), ('134', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '3787', null, null, '3'), ('135', 'Пригласить для проведения презентации представителя компании, создавшей аналитическую систему ', '0', '90', '1', '3787', null, null, '5'), ('136', 'Написать служебку на выделение денег для сервера', '0', '30', '1', '3820', null, null, '5'), ('137', 'Подготовить регламент адаптации и введения в должность сотрудников отдела анализа и региональных сотрудников', '0', '180', '1', '3831', null, null, '5'), ('138', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '3846', null, null, '3'), ('139', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '3846', null, null, '5'), ('140', 'Уволить Трутнева', '0', '30', '1', '3846', null, null, '5'), ('141', 'Доделать презентацию для ГД', '0', '180', '1', '3846', null, null, '5'), ('142', 'Подготовить график отпусков', '0', '60', '1', '3846', null, null, '4'), ('143', 'Подготовить документ о конфиденциальности и не разглашении  информации', '0', '60', '1', '3852', null, null, '5'), ('144', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '3852', null, null, '5'), ('145', 'Заказать закупку двух столов и одного шкафа для бумаг (выбрать из каталога)', '0', '30', '1', '3852', null, null, '5'), ('146', 'Проверить график и написать консультантам удобное время для встречи', '0', '30', '1', '3852', null, null, '5'), ('147', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '3932', null, null, '3'), ('148', 'Переслать старую презентацию с комментариями', '0', '30', '1', '3992', null, null, '5'), ('149', 'Встретиться с аналитиками для планирования отпусков и их стыковки', '0', '30', '1', '3992', null, null, '5'), ('150', 'Сделать регламент по процессу заказа работ в отделе анализа', '0', '180', '1', '3992', null, null, '5'), ('151', 'Проверить в бюджете наличие средств на покупку фото файлов', '0', '30', '1', '3992', null, null, '5'), ('152', 'Собрать ребят на Новый год', '0', '90', '1', '3992', null, null, '5'), ('153', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '4000', null, null, '3'), ('154', 'Встретиться с аналитиками для планирования отпусков и их стыковки', '0', '30', '1', '4000', null, null, '5'), ('155', 'Подготовить регламент адаптации и введения в должность сотрудников отдела анализа', '0', '180', '1', '4000', null, null, '5'), ('156', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '4002', null, null, '3'), ('157', 'Подготовить график отпусков', '0', '60', '1', '4002', null, null, '4'), ('158', 'Встретиться с Сергеем Ивановичем', '0', '60', '1', '4002', null, null, '5'), ('159', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '4007', null, null, '3'), ('160', 'Договориться с Железным об использовании резервных мощностей', '0', '30', '1', '4012', null, null, '5'), ('169', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '4393', null, null, '3'), ('170', 'Проверить презентацию для ГД в 15.30', '0', '30', '1', '4479', null, null, '5'), ('171', 'Доделать презентацию для ГД', '0', '180', '1', '4479', null, null, '5'), ('172', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '4479', null, null, '3'), ('173', 'Написать тезисы выступления на конференции \"Аналитика и бизнес\"', '0', '90', '1', '4479', null, null, '3'), ('174', 'Провести индивидуальные встречи с аналитиками', '0', '90', '1', '4479', null, null, '2'), ('175', 'Посмотреть цены на авиа-перелет в Барселону', '0', '30', '1', '4479', null, null, '5'), ('176', 'Найти и переслать старый график отпусков', '0', '30', '1', '4479', null, null, '5'), ('177', 'Встретиться с руководителями отделов для обсуждения формата презентации на стратегическую сессию', '0', '60', '1', '4479', null, null, '5'), ('178', 'Провести совместную встречу со всеми аналитиками', '0', '60', '1', '4602', null, null, '5'), ('179', 'Найти и переслать старый график отпусков', '0', '30', '1', '4602', null, null, '5'), ('180', 'Доделать презентацию для ГД', '0', '180', '1', '4602', null, null, '5'), ('181', 'Проверить наличие данных по пенсионным свидетельствам всех сотрудников отдела', '0', '30', '1', '4602', null, null, '5'), ('182', 'Подготовить отчет по складским остаткам региона С', '0', '60', '1', '4602', null, null, '5'), ('183', 'Пригласить для проведения презентации представителя компании, создавшей аналитическую систему ', '0', '90', '1', '4602', null, null, '5'), ('184', 'Доделать презентацию для ГД', '0', '180', '1', '4993', null, null, '5'), ('185', 'Проверить презентацию для ГД в 15.30', '0', '30', '1', '4993', null, null, '5'), ('186', 'Сделать план закрытия вакансий', '0', '30', '1', '4993', null, null, '5'), ('187', 'Подготовить предложения по формату презентации на стратегическую сессию', '0', '90', '1', '4993', null, null, '3'), ('188', 'Уволить Трутнева', '0', '30', '1', '4993', null, null, '5'), ('189', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '4993', null, null, '3'), ('190', 'Подготовить график отпусков', '0', '60', '1', '4993', null, null, '4'), ('191', 'Запланировать деньги на сервер в бюджете на январь', '0', '30', '1', '4993', null, null, '5'), ('192', 'Встретиться с директором по продажам для обсуждения сроков отчетности', '0', '60', '1', '4995', null, null, '5'), ('193', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '5053', null, null, '3'), ('194', 'Подготовить график отпусков', '0', '60', '1', '5054', null, null, '4'), ('195', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '5054', null, null, '3'), ('196', 'Спросить Трудякина - о чем беседа и как к ней подготовиться', '0', '30', '1', '5054', null, null, '5'), ('197', 'Доделать презентацию для ГД', '0', '180', '1', '5067', null, null, '5'), ('198', 'Проверить презентацию для ГД в 15.30', '0', '30', '1', '5067', null, null, '5'), ('199', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '5067', null, null, '3'), ('200', 'Провести индивидуальные встречи с аналитиками', '0', '90', '1', '5067', null, null, '2'), ('201', 'Подготовить график отпусков', '0', '60', '1', '5067', null, null, '4'), ('202', 'Встретиться с руководителями отделов для обсуждения формата презентации на стратегическую сессию', '0', '60', '1', '5067', null, null, '5'), ('203', 'Пригласить для проведения презентации представителя компании, создавшей аналитическую систему ', '0', '90', '1', '5067', null, null, '5'), ('204', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '5728', null, null, '3'), ('205', 'Подготовиться к встрече с консультантами', '0', '30', '1', '5926', null, null, '5'), ('206', 'Подготовить график отпусков', '0', '60', '1', '6239', null, null, '4'), ('207', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '6668', null, null, '3'), ('208', 'Поменять рабочие места Лошадкина и Трутнева (Трутневу и одного стола хватит)', '0', '30', '1', '6781', null, null, '5'), ('209', 'Связаться с аналитиком из региона С для знакомства и первичных инструкций', '0', '60', '1', '6781', null, null, '3'), ('210', 'Подготовить график отпусков', '0', '60', '1', '6781', null, null, '4'), ('211', 'Написать тезисы выступления на конференции \"Аналитика и бизнес\"', '0', '90', '1', '6781', null, null, '3'), ('212', 'Поговорить с Денежной о повышении ЗП', '0', '30', '1', '6781', null, null, '5'), ('213', 'Написать служебку на выделение денег для сервера', '0', '30', '1', '7004', null, null, '5'), ('214', 'Подготовить данные по экономике компании для встречи с консультантами', '0', '180', '1', '7013', null, null, '5'), ('215', 'Отдать сервер в ремонт специализированной компании', '0', '60', '1', '7013', null, null, '5'), ('216', 'Проверить наши прогнозы по продажам в сводном бюджете на базе данных о динамике рынка', '0', '90', '1', '7013', null, null, '5'), ('217', 'Проверить наши прогнозы по продажам в сводном бюджете на базе данных о динамике рынка', '0', '90', '1', '7013', null, null, '5'), ('218', 'Подготовить график отпусков', '0', '60', '1', '7013', null, null, '4');
                COMMIT;

                SET FOREIGN_KEY_CHECKS = 1;

            ";
            $connection->createCommand($tasks)->execute();
            $transaction->commit();
        }
        catch(Exception $e)
        {
            echo "Exception: ".$e->getMessage()."\n";
            $transaction->rollback();
            return false;
        }
	}

}